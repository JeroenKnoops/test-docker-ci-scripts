on: [push]

name: test

jobs:
  build:
    name: Build docker image 
    runs-on: ubuntu-20.04
    outputs:
      container-digest: ${{ steps.docker.outputs.container-digest }}
      container-tags: ${{ steps.docker.outputs.container-tags }}
      container-repo: jeroenknoops/test-image
      push-indicator: ${{ steps.docker.outputs.push-indicator }}

    steps:
    - uses: actions/checkout@v1
      with:
        submodules: true

    - uses: philips-software/docker-ci-scripts@add-slsa-provenance
      id: docker
      with:
        dockerfile: 1
        image-name: test-image 
        tags: 'latest 1 1.2 1.2.1'
        slsa-provenance: true
      env:
        DOCKER_USERNAME: jeroenknoops 
        DOCKER_PASSWORD: '${{ secrets.DOCKER_PASSWORD }}'
        DOCKER_ORGANIZATION: jeroenknoops

    - name: Upload a Build Artifact
      uses: actions/upload-artifact@v2.3.1
      with:
        name: provenance
        path: ${{ steps.docker.outputs.slsa-provenance-file }}
        retention-days: 5
        
    - name: Output digest
      run: |
        echo "container-digest: ${{ steps.docker.outputs.container-digest }}"
        echo "container-tags: ${{ steps.docker.outputs.container-tags }}"
        echo "push-indicator: ${{ steps.docker.outputs.push-indicator }}"

  container-provenance:
    name: container-provenance
    needs: [build]
    if: needs.build.outputs.push-indicator == 'true'
    runs-on: ubuntu-20.04

    steps:
      - name: Install cosign
        uses: sigstore/cosign-installer@v1.4.1
        with:
          cosign-release: 'v1.4.1'
          
      - name: Download a Build Artifact
        uses: actions/download-artifact@v2.1.0
        with:
          name: provenance

      - name: Debug provenance
        run: |
          cat provenance.json

      - name: Login to Container registries
        run: |
          echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u jeroenknoops --password-stdin

      - name: Only predicate part
        run: |
          cat provenance.json | jq .predicate > provenance-predicate.json

      - name: Attach provenance to image
        run: |
          echo '${{ secrets.COSIGN_PRIVATE_KEY }}' > cosign.key
          cosign attest --predicate provenance-predicate.json --key cosign.key --type slsaprovenance ${{ needs.build.outputs.container-repo }}@${{ needs.build.outputs.container-digest }}
        env:
          COSIGN_PASSWORD: ${{ secrets.COSIGN_PASSWORD }}

      - name: Verify attestation
        run: |
          echo '${{ secrets.COSIGN_PUBLIC_KEY }}' > cosign.pub
          cosign verify-attestation --key cosign.pub ${{ needs.build.outputs.container-repo }}@${{ needs.build.outputs.container-digest }}

      - name: Logout from Container registries
        if: ${{ always() }}
        run: |
          docker logout
